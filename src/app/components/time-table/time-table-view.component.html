<div class="timetable-container">
  <h2 class="title">
    Time Table
  </h2>

  <div class="add-timetable">
    <button class="add-timetable-btn" routerLink="/time-table" *ngIf="userRole === 'ADMIN'">Add New Time Table</button>
  </div>

  <table class="timetable">
    <thead>
      <tr>
        <th>Week Period</th>
        <th *ngIf="userRole === 'ADMIN' || userRole === 'TEACHER'">Batch</th>
        <th *ngIf="userRole === 'ADMIN' || userRole === 'TEACHER'">Medium</th>
        <th *ngIf="userRole === 'ADMIN' || userRole === 'TEACHER'">Plan</th>
        <th *ngIf="userRole === 'ADMIN'">Assigned Teacher</th>
        <th *ngFor="let day of ['monday','tuesday','wednesday','thursday','friday','saturday','sunday']">
          {{ day | titlecase }}
        </th>
        
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let weekGroup of groupByWeek(timeTables, userRole === 'STUDENT')">
        <ng-container *ngFor="let tt of weekGroup.items; let i = index">
          <tr>
            <td *ngIf="i === 0" [attr.rowspan]="weekGroup.items.length" data-label="Week Period">
              <span>{{ tt.weekStartDate | date:'M/d/yy' }} - {{ tt.weekEndDate | date:'M/d/yy' }}</span>
            </td>
            <td *ngIf="userRole === 'ADMIN' || userRole === 'TEACHER'" data-label="Batch"><span>{{ tt.batch }}</span></td>
            <td *ngIf="userRole === 'ADMIN' || userRole === 'TEACHER'" data-label="Medium"><span>{{ tt.medium }}</span></td>
            <td *ngIf="userRole === 'ADMIN' || userRole === 'TEACHER'" data-label="Plan"><span>{{ tt.plan }}</span></td>

            <td *ngIf="userRole === 'ADMIN'" data-label="Assigned Teacher">
              <span>{{ teachersCache[tt.assignedTeacher] || 'Loading...' }}</span>
            </td>

            <td *ngFor="let day of ['monday','tuesday','wednesday','thursday','friday','saturday','sunday']" 
                [attr.data-label]="day | titlecase">
              <span>
                <ng-container *ngIf="tt[day] && tt[day].length > 0; else noSlot">
                  <div *ngFor="let slot of tt[day]">
                    {{ slot.start }} - {{ slot.end }}
                      <div 
                        class="slot-status" 
                        [ngClass]="{
                          'scheduled': slot.classStatus === 'Scheduled',
                          'cancelled': slot.classStatus === 'Cancelled'
                        }"
                      >
                        ({{ slot.classStatus }})
                      </div>
                  </div>
                </ng-container>
                <ng-template #noSlot>-</ng-template>
              </span>
            </td>

            <td class="updateTD" *ngIf="userRole === 'ADMIN'">
              <button 
                class="btn btn-outline-primary btn-sm"
                [routerLink]="['/time-table', tt._id]"
              >
                Update
              </button>
            </td>
          </tr>
        </ng-container>
      </ng-container>
    </tbody>
  </table>
</div>
