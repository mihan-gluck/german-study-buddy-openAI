<!-- src/app/components/ai-tutor-chat/ai-tutor-chat.component.html -->

<div class="ai-tutor-container" 
     [class.roleplay-mode]="isRolePlayModule()"
     *ngIf="!isLoading">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-content">
      <div class="module-info">
        <h2>{{ getSessionTypeLabel() }}</h2>
        <p *ngIf="module">{{ module.title }} - {{ module.level }}</p>
        
        <!-- Role-Play Information -->
        <div class="roleplay-info" *ngIf="isRolePlayModule()">
          <div class="roleplay-badge">üé≠ Role-Play Session</div>
          <div class="roles-display">
            <span class="role-item">
              <strong>You:</strong> {{ getRolePlayInfo()?.studentRole }}
            </span>
            <span class="role-separator">vs</span>
            <span class="role-item">
              <strong>AI:</strong> {{ getRolePlayInfo()?.aiRole }}
            </span>
          </div>
          <div class="scenario-info">
            <small>üìç {{ getRolePlayInfo()?.situation }}</small>
          </div>
          
          <!-- Conversation Statistics -->
          <div class="conversation-stats" *ngIf="sessionActive && messages.length > 0">
            <div class="stat">
              <i class="fas fa-comments"></i>
              <span>{{ getStudentMessageCount() }} your messages</span>
            </div>
            <div class="stat">
              <i class="fas fa-robot"></i>
              <span>{{ getAIMessageCount() }} AI responses</span>
            </div>
            <div class="stat">
              <i class="fas fa-microphone"></i>
              <span>{{ getSpeechMessageCount() }} spoken</span>
            </div>
          </div>
          
          <!-- Toggle button for detailed info -->
          <button class="info-toggle-btn" (click)="showRolePlayDetails = !showRolePlayDetails">
            {{ showRolePlayDetails ? 'Hide Details' : 'Show Details' }}
            <i class="fas" [class.fa-chevron-up]="showRolePlayDetails" [class.fa-chevron-down]="!showRolePlayDetails"></i>
          </button>
        </div>
      </div>
      
      <div class="session-stats" *ngIf="sessionActive">
        <div class="stat-item">
          <span class="stat-label">Messages:</span>
          <span class="stat-value">{{ sessionStats.totalMessages }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Score:</span>
          <span class="stat-value">{{ sessionStats.sessionScore }}</span>
        </div>
        <div class="stat-item" *ngIf="sessionStats.correctAnswers + sessionStats.incorrectAnswers > 0">
          <span class="stat-label">Accuracy:</span>
          <span class="stat-value">{{ getScorePercentage() }}%</span>
        </div>
        <div class="stat-item voice-status" *ngIf="voiceEnabled">
          <span class="stat-label">Voice:</span>
          <span class="stat-value">
            <i class="fas" 
               [class.fa-microphone]="isListening" 
               [class.fa-volume-up]="isSpeaking" 
               [class.fa-spinner]="isProcessingSpeech"
               [class.fa-spin]="isProcessingSpeech"
               [class.fa-headphones]="!isListening && !isSpeaking && !isProcessingSpeech"></i>
            {{ isListening ? 'Listening...' : isSpeaking ? 'Speaking...' : isProcessingSpeech ? 'Processing...' : 'Ready' }}
          </span>
        </div>
      </div>
      
      <div class="header-actions">
        <button 
          class="btn btn-outline-secondary btn-sm"
          (click)="router.navigate(['/learning-modules', moduleId])"
          title="Back to Module">
          ‚Üê Back
        </button>
        <button 
          class="btn btn-danger btn-sm"
          (click)="endSession()"
          *ngIf="sessionActive"
          title="End Session">
          End Session
        </button>
      </div>
    </div>
  </div>

  <!-- Detailed Role-Play Information Panel -->
  <div class="roleplay-details-panel" *ngIf="isRolePlayModule() && showRolePlayDetails && rolePlayDetails">
    <div class="details-container">
      <div class="details-grid">
        <!-- Scenario Information -->
        <div class="detail-card scenario-card">
          <h4><i class="fas fa-map-marker-alt"></i> Scenario</h4>
          <p><strong>Situation:</strong> {{ rolePlayDetails.scenario }}</p>
          <p><strong>Setting:</strong> {{ rolePlayDetails.setting }}</p>
          <p><strong>Objective:</strong> {{ rolePlayDetails.objective }}</p>
        </div>

        <!-- Roles Information -->
        <div class="detail-card roles-card">
          <h4><i class="fas fa-users"></i> Roles</h4>
          <div class="role-assignment">
            <div class="role-item student-role">
              <strong>Your Role:</strong> {{ rolePlayDetails.studentRole }}
            </div>
            <div class="role-item ai-role">
              <strong>AI Role:</strong> {{ rolePlayDetails.aiRole }}
            </div>
          </div>
        </div>

        <!-- Vocabulary Constraints -->
        <div class="detail-card vocabulary-card">
          <h4><i class="fas fa-book"></i> Allowed Vocabulary</h4>
          <div class="vocabulary-list">
            <span 
              *ngFor="let vocab of rolePlayDetails.allowedVocabulary.slice(0, 12)" 
              class="vocab-tag"
              [title]="vocab.translation">
              {{ vocab.word }}
            </span>
            <span *ngIf="rolePlayDetails.allowedVocabulary.length > 12" class="more-indicator">
              +{{ rolePlayDetails.allowedVocabulary.length - 12 }} more...
            </span>
          </div>
        </div>

        <!-- Grammar Constraints -->
        <div class="detail-card grammar-card">
          <h4><i class="fas fa-language"></i> Grammar Focus</h4>
          <div class="grammar-list">
            <div *ngFor="let grammar of rolePlayDetails.allowedGrammar" class="grammar-item">
              <strong>{{ grammar.structure }}</strong>
              <div class="grammar-examples">
                <small *ngFor="let example of grammar.examples.slice(0, 2)">
                  "{{ example }}"
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Conversation Flow -->
        <div class="detail-card flow-card" *ngIf="rolePlayDetails.conversationFlow && rolePlayDetails.conversationFlow.length > 0">
          <h4><i class="fas fa-route"></i> Conversation Flow</h4>
          <div class="flow-stages">
            <div *ngFor="let stage of rolePlayDetails.conversationFlow.slice(0, 4)" class="stage-item">
              <div class="stage-title">{{ stage.stage | titlecase }}</div>
              <div class="stage-phrases">
                <small *ngFor="let phrase of stage.helpfulPhrases?.slice(0, 2)">
                  "{{ phrase }}"
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Instructions -->
        <div class="detail-card instructions-card">
          <h4><i class="fas fa-info-circle"></i> How to Play</h4>
          <div class="instructions-list">
            <div class="instruction-item">
              <i class="fas fa-play-circle"></i>
              <span>Say <strong>"Let's start"</strong> or <strong>"Begin"</strong> to start the role-play</span>
            </div>
            <div class="instruction-item">
              <i class="fas fa-stop-circle"></i>
              <span>Say <strong>"stop"</strong> or <strong>"end"</strong> to finish anytime</span>
            </div>
            <div class="instruction-item">
              <i class="fas fa-comments"></i>
              <span>Stay in character and use only the allowed vocabulary</span>
            </div>
            <div class="instruction-item">
              <i class="fas fa-microphone"></i>
              <span>Use voice or text to communicate with the AI</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages Container -->
  <div class="messages-container" #messagesContainer>
    <!-- Speech Processing Indicator -->
    <div class="speech-processing-indicator" *ngIf="isProcessingSpeech">
      <i class="fas fa-microphone fa-spin"></i>
      <span>Processing your speech...</span>
    </div>
    
    <div class="messages-list">
      <!-- Debug: Show message count -->
      <div class="debug-info" *ngIf="messages.length === 0" style="text-align: center; padding: 2rem; color: #6c757d;">
        <p>No messages yet. Start a conversation!</p>
        <button class="btn btn-sm btn-outline-primary" (click)="refreshMessages()">Refresh Messages</button>
      </div>
      
      <!-- Conversation Start Indicator -->
      <div class="conversation-indicator" *ngIf="messages.length > 0">
        <span>Conversation Started ({{ messages.length }} messages)</span>
        <button class="btn btn-sm btn-outline-secondary ms-2" (click)="refreshMessages()">Refresh</button>
      </div>
      
      <div 
        *ngFor="let message of messages; let i = index" 
        class="message-wrapper"
        [ngClass]="getMessageClass(message)">
        
        <!-- Message Avatar -->
        <div class="message-avatar">
          <i class="fas" [class.fa-user]="message.role === 'student'" [class.fa-robot]="message.role === 'tutor'"></i>
        </div>
        
        <div class="message-bubble">
          <div class="message-header" *ngIf="message.messageType !== 'text' || message.metadata?.inputMethod">
            <span class="message-type-icon">{{ getMessageTypeIcon(message.messageType) }}</span>
            <span class="message-type">{{ message.messageType | titlecase }}</span>
            <!-- Input method indicator for student messages -->
            <span class="input-method-indicator" *ngIf="message.role === 'student' && message.metadata?.inputMethod">
              <i class="fas" 
                 [class.fa-microphone]="message.metadata?.inputMethod === 'speech'"
                 [class.fa-keyboard]="message.metadata?.inputMethod === 'text'"
                 [title]="message.metadata?.inputMethod === 'speech' ? 'Spoken message' : 'Typed message'"></i>
              {{ message.metadata?.inputMethod === 'speech' ? 'Spoken' : 'Typed' }}
            </span>
          </div>
          
          <div class="message-content">
            <!-- Add speaker indicator for AI messages -->
            <div class="speaker-label" *ngIf="message.role === 'tutor'">
              <i class="fas fa-robot"></i> 
              <span>AI {{ module?.content?.rolePlayScenario?.aiRole || 'Tutor' }}</span>
            </div>
            <div class="speaker-label" *ngIf="message.role === 'student'">
              <i class="fas fa-user"></i> 
              <span>You {{ module?.content?.rolePlayScenario ? '(' + module.content.rolePlayScenario.studentRole + ')' : '' }}</span>
            </div>
            <div class="message-text">
              {{ message.content }}
            </div>
            
            <!-- Message Status -->
            <div class="message-status" *ngIf="message.role === 'student'">
              <i class="fas fa-check-circle" *ngIf="message.timestamp"></i>
              <span>Sent</span>
            </div>
          </div>
          
          <!-- Exercise Display -->
          <div class="exercise-content" *ngIf="message.messageType === 'exercise' && message.metadata">
            <div class="exercise-question">
              <strong>{{ message.metadata.question }}</strong>
            </div>
            
            <!-- Multiple Choice Options -->
            <div class="exercise-options" *ngIf="message.metadata.options && message.metadata.options.length > 0">
              <div 
                *ngFor="let option of message.metadata.options; let i = index"
                class="option-item">
                {{ getOptionLetter(i) }}. {{ option }}
              </div>
            </div>
            
            <div class="exercise-points" *ngIf="message.metadata.points">
              Points: {{ message.metadata.points }}
            </div>
          </div>
          
          <!-- Feedback Display -->
          <div class="feedback-content" *ngIf="message.messageType === 'feedback' && message.metadata">
            <div class="feedback-result" [ngClass]="message.metadata.isCorrect ? 'correct' : 'incorrect'">
              {{ message.metadata.isCorrect ? '‚úÖ Correct!' : '‚ùå Incorrect' }}
              <span *ngIf="message.metadata.points"> (+{{ message.metadata.points }} points)</span>
            </div>
          </div>
          
          <div class="message-timestamp">
            {{ formatTimestamp(message.timestamp) }}
          </div>
        </div>
      </div>
      
      <!-- Loading indicator -->
      <div class="message-wrapper message-tutor" *ngIf="isSending">
        <div class="message-bubble">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Exercise Answer Input -->
  <div class="exercise-input-container" *ngIf="currentExercise && sessionActive">
    <div class="exercise-prompt">
      <h4>Answer the Exercise:</h4>
      <p>{{ currentExercise.question }}</p>
    </div>
    
    <div class="input-group">
      <input 
        type="text"
        class="form-control"
        [(ngModel)]="exerciseAnswer"
        placeholder="Type your answer..."
        (keyup.enter)="submitExerciseAnswer()"
        [disabled]="isSending">
      
      <button 
        class="btn btn-primary"
        (click)="submitExerciseAnswer()"
        [disabled]="!exerciseAnswer.trim() || isSending">
        Submit Answer
      </button>
    </div>
  </div>

  <!-- Message Input -->
  <div class="message-input-container" *ngIf="!currentExercise && sessionActive">
    <!-- Speech Processing Feedback -->
    <div class="speech-feedback" *ngIf="isProcessingSpeech">
      <div class="alert alert-info">
        <i class="fas fa-microphone fa-spin"></i>
        <strong>Processing your speech...</strong>
        <small>Your words will appear below and be sent automatically</small>
      </div>
    </div>
    
    <!-- Suggestions -->
    <div class="suggestions-container" *ngIf="suggestions.length > 0">
      <div class="suggestions-label">Suggestions:</div>
      <div class="suggestions-list">
        <button 
          *ngFor="let suggestion of suggestions"
          class="btn btn-outline-primary btn-sm suggestion-btn"
          (click)="useSuggestion(suggestion)">
          {{ suggestion }}
        </button>
      </div>
    </div>
    
    <!-- Message Input -->
    <div class="input-group">
      <!-- Voice Controls -->
      <div class="voice-controls" *ngIf="voiceEnabled">
        <button 
          class="btn btn-outline-primary btn-sm voice-btn"
          [class.btn-danger]="isListening"
          (click)="isListening ? stopListening() : startListening()"
          [disabled]="isSending || isProcessingSpeech"
          title="Voice Input">
          <i class="fas" [class.fa-microphone]="!isListening" [class.fa-stop]="isListening"></i>
          {{ isListening ? 'Stop' : 'Speak' }}
        </button>
        
        <button 
          class="btn btn-outline-secondary btn-sm voice-btn"
          (click)="stopSpeaking()"
          [disabled]="!isSpeaking"
          title="Stop Speaking">
          <i class="fas fa-volume-mute"></i>
        </button>
        
        <button 
          class="btn btn-outline-info btn-sm voice-btn"
          (click)="toggleVoice()"
          title="Toggle Voice">
          <i class="fas" [class.fa-volume-up]="voiceEnabled" [class.fa-volume-mute]="!voiceEnabled"></i>
        </button>
      </div>
      
      <input 
        type="text"
        class="form-control"
        [(ngModel)]="currentMessage"
        placeholder="Type your message or use voice input..."
        (keyup.enter)="sendMessage()"
        [disabled]="isSending || isProcessingSpeech"
        [class.speech-captured]="isProcessingSpeech">
      
      <button 
        class="btn btn-primary"
        (click)="sendMessage()"
        [disabled]="!currentMessage.trim() || isSending || isProcessingSpeech">
        {{ isProcessingSpeech ? 'Processing...' : 'Send' }}
      </button>
    </div>
  </div>

  <!-- Session Inactive Message -->
  <div class="session-inactive" *ngIf="!sessionActive">
    <div class="alert alert-info">
      <h4>Session Ended</h4>
      <p>Your tutoring session has ended. You can start a new session or return to the module.</p>
      <button 
        class="btn btn-primary me-2"
        (click)="startNewSession()">
        Start New Session
      </button>
      <button 
        class="btn btn-outline-secondary"
        (click)="router.navigate(['/learning-modules', moduleId])">
        Back to Module
      </button>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="isLoading">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Starting your AI tutoring session...</p>
  </div>
</div>