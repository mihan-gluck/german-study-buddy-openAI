<!--student-dashboard.component.html-->

<div class="dashboard-container">
  <h2>Welcome to Student Dashboard</h2>

  <div *ngIf="userProfile" class="profile-box">
  <h3>Your Profile</h3>

  <div class="profile-info">
    <img 
      [src]="userProfile.profilePhoto || 'assets/default-profile.png'" 
      alt="Profile Photo" 
      class="profile-photo"
    />
    <div class="details">
      <p><strong>Name:</strong> {{ userProfile.name }}</p>
      <p><strong>Email:</strong> {{ userProfile.email }}</p>
      <p><strong>Current Level:</strong> {{ userProfile.level || 'Not Set' }}</p>
    </div>
  </div>
</div>


  <div *ngIf="loading">Loading courses...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <div *ngIf="!loading && vapiCourses.length > 0" class="course-list">
    <div *ngFor="let course of vapiCourses" class="course-card">
      <h3>{{ course.name }}</h3>
      <button (click)="startCall(course)" [disabled]="vapiActive">Start</button>
      <button (click)="stopCall()" [disabled]="!vapiActive">Stop</button>
    </div>
  </div>

  <div *ngIf="vapiActive" class="status">Voice assistant is active...</div>

  <!-- Feedback Section -->
<div *ngIf="feedbackLoading">Loading your feedback...</div>
<div *ngIf="feedbackError" class="error">{{ feedbackError }}</div>

<div *ngIf="!feedbackLoading && feedbackList.length > 0" class="feedback-table">
  <h3>Your Teacher's Feedback</h3>
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Summary</th>
        <th>Conversation Time</th>
        <th>Fluency</th>
        <th>Accent</th>
        <th>Grammar</th>
        <th>Overall</th>
        <th>Mistakes</th>
        <th>Level</th>
        <th>Suggestions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let fb of feedbackList">
        <td>{{ fb.timestamp | date: 'short' }}</td>
        <td>{{ fb.summary }}</td>
        <td>{{ fb.conversationTime }} min</td>
        <td>{{ fb.fluency }}</td>
        <td>{{ fb.accent }}</td>
        <td>{{ fb.grammar }}</td>
        <td>{{ fb.overallCfbr }}</td>
        <td>{{ fb.commonMistakes }}</td>
        <td>{{ fb.currentLevel }}</td>
        <td>{{ fb.suggestedImprovement }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="!feedbackLoading && feedbackList.length === 0">
  <p>No feedback available yet. Please check back later.</p>
</div>

<!-- Profile Info -->
<div *ngIf="authService.getUser() as user" class="profile-box">
  <h3>Your Profile</h3>
  <p><strong>Name:</strong> {{ user.name }}</p>
  <p><strong>Email:</strong> {{ user.email }}</p>
  <p><strong>Current Level:</strong> {{ user.level || 'Not Set' }}</p>
</div>

<!-- Feedback Summary -->
<div *ngIf="feedbackList.length">
  <h3>Feedback Summary</h3>
  <p><strong>Average Fluency:</strong> {{ getAverageScore('fluency') | number:'1.1-2' }}</p>
  <p><strong>Average Grammar:</strong> {{ getAverageScore('grammar') | number:'1.1-2' }}</p>
  <!-- Add more if needed -->
</div>

<!-- CSV Export -->
<button (click)="exportToCSV()" *ngIf="feedbackList.length">Download Feedback as CSV</button>

  
</div>



<!-- <div class="container mt-4">
  
  <p>Select a course-level AI tutor below:</p>

  <div *ngFor="let course of vapiCourses" class="card">
  <h4>{{ course.name }}</h4>
  <button (click)="openVapiTab(course.name)">Open AI Voice Agent</button>
</div>

<h2>Available AI Courses</h2>
<div *ngIf="vapiCourses.length > 0; else noCourses">
  <div *ngFor="let course of vapiCourses" class="course-button">
    <button (click)="openAgent(course)">
      ðŸŽ§ {{ course.name }} - Talk with AI
    </button>
  </div>
</div>

<div *ngIf="loading">Loading courses...</div>
<p *ngIf="error">{{ error }}</p>


<ng-template #noCourses>
  <p>No subscribed courses found.</p>
</ng-template>



  <div class="row">
    <div
      class="col-md-6 mb-4"
      *ngFor="let agent of aiAgents"
    >
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">{{ agent.name }}</h5>
          <iframe
            [src]="agent.url | safeUrl"
            width="100%"
            height="350"
            style="border: 1px solid #ccc; border-radius: 8px;"
          ></iframe>
        </div>
      </div>
    </div>
  </div>
</div>
 -->
<!-- Vapi widget will be automatically loaded here via script -->


<!-- <div class="student-dashboard-container">
  <div class="container">
    <h2 class="text-center mb-4">Welcome to Your Dashboard</h2>
    <p class="text-center mb-4">Select an AI Agent to start your conversation:</p>

    <div class="row justify-content-center">
      <div class="col-md-6 col-lg-4 mb-4" *ngFor="let agent of aiAgents">
        <div class="card shadow-lg">
          <div class="card-body text-center">
            <h5 class="card-title">{{ agent.name }}</h5>
            <p class="card-text">Start interacting with the AI at your level.</p>
            <a [href]="agent.url" class="btn btn-primary" target="_blank">Start Conversation</a>
          </div>
        </div>
      </div>
    </div>

     Centered Vapi Widget 
    <div id="vapi-widget-container" class="vapi-center-container"></div>
  </div>
</div> -->


<!-- <div class="student-dashboard-container">
  <div class="container">
    <h2 class="text-center mb-4">Welcome to Your Dashboard</h2>
    <p class="text-center mb-4">Select an AI Agent to start your conversation:</p>

    <div class="row justify-content-center">
      <div class="col-md-6 col-lg-4 mb-4" *ngFor="let agent of aiAgents">
        <div class="card shadow-lg">
          <div class="card-body text-center">
            <h5 class="card-title">{{ agent.name }}</h5>
            <p class="card-text">Start interacting with the AI at your level.</p>
            <a [href]="agent.url" class="btn btn-primary" target="_blank">Start Conversation</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="student-dashboard">
    <h2>Student Dashboard</h2>
    <p>Select an AI Agent to start your conversation:</p>
    <div class="ai-agent-links">
      <button *ngFor="let agent of aiAgents" (click)="openAgent(agent.url)">
        {{ agent.name }}
      </button>
    </div>
  </div>-->
  